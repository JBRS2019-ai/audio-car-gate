<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TM Audio ‚Äî Start Listening</title>

<!-- TensorFlow.js (pinned to a compatible version) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<!-- Teachable Machine AUDIO runtime -->
<script src="https://teachablemachine.withgoogle.com/js/teachablemachine-audio.min.js"></script>

<style>
  html,body{margin:0;height:100%;background:#e0551b;color:#fff;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;display:grid;place-items:center}
  button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;background:#fff;color:#e0551b}
  #status{margin-top:12px;font-weight:800}
</style>
</head>
<body>

<button id="start">üéôÔ∏è Start Listening</button>
<div id="status">Idle</div>

<script>
  // ===== minimal helpers =====
  const $ = sel => document.querySelector(sel);
  const setStatus = t => $("#status").textContent = t;
  const getModelBase = () => {
    const m = new URL(location.href).searchParams.get("model");
    if (!m) return null;
    return /^https?:\/\//i.test(m) ? (m.endsWith("/") ? m : m + "/")
                                   : `https://teachablemachine.withgoogle.com/models/${m}/`;
  };
  const uartSend = s => (typeof sendUART === "function") ? sendUART(String(s) + "\n")
                                                         : console.log("UART:", s);

  // ===== audio init & loop =====
  let model, mic, running = false, last = "";

  async function startListening(){
    if (running) return;
    const base = getModelBase();
    if (!base) { alert("Add ?model=<AudioModelID or full URL>"); return; }

    try {
      setStatus("Loading model‚Ä¶");
      model = await tmAudio.load(base + "model.json", base + "metadata.json");

      setStatus("Opening microphone‚Ä¶");
      mic = new tmAudio.Microphone();
      await mic.setup();       // user allows mic
      await mic.play();

      setStatus("Listening‚Ä¶");
      running = true;
      loop();
    } catch (err) {
      console.error("initAudio error:", err);
      setStatus("Error: " + (err?.message || "see console"));
      alert("Could not start audio model. " + (err?.message || "See console."));
    }
  }

  async function loop(){
    if (!running) return;
    try {
      const preds = await model.predict(mic);
      preds.sort((a,b)=>b.probability - a.probability);
      const top = preds[0] || {className:"Idle", probability:0};
      const label = `${top.className} (${Math.round(top.probability*100)}%)`;
      setStatus(label);

      if (top.className !== last) {
        uartSend(top.className);   // optional: only if sendUART exists
        last = top.className;
      }
      await tf.nextFrame();
    } finally {
      requestAnimationFrame(loop);
    }
  }

  $("#start").addEventListener("click", startListening);
</script>
</body>
</html>
