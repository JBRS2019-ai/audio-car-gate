<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TM Audio + micro:bit UART ‚Äî Minimal</title>

<!-- Per TM Audio README -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<!-- Your original Bluetooth bridge (keep this file in the same folder) -->
<script src="microbit_uart_ble.js"></script>

<style>
  html,body{margin:0;height:100%;display:grid;place-items:center;background:#e0551b;color:#fff;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
  .wrap{display:grid;gap:10px;place-items:center}
  button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;background:#fff;color:#e0551b;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  #status{font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <div>
    <button id="connect" onclick="connectButtonPressed()">üîó Connect micro:bit</button>
    <button id="start">üéôÔ∏è Start Listening</button>
  </div>
  <div id="status">Idle</div>
</div>

<script>
/* ============ 1) Model URL from ?model= or fallback ============ */
const url = new URL(location.href);
const id  = url.searchParams.get("model") || "2zT_UljVK";  // <-- your default
const MODEL_BASE = /^https?:\/\//.test(id)
  ? (id.endsWith("/") ? id : id + "/")
  : `https://teachablemachine.withgoogle.com/models/${id}/`;

/* ============ 2) Teachable Machine AUDIO ============ */
const PROB_THRESHOLD = 0.90;
const OVERLAP = 0.20;
const SEND_SUFFIX = "\n";    // MakeCode: lees tot nieuwe regel

// Optional mapping (rename labels before sending)
const MAP_TO_UART = {
  // "Auto": "Class 2",
  // "Geenauto": "Achtergrondruis",
};

const $ = s => document.querySelector(s);
const setStatus = t => $("#status").textContent = t;

let recognizer, labels, lastLabel = "";

async function createModel() {
  const rec = speechCommands.create(
    "BROWSER_FFT",
    undefined,
    MODEL_BASE + "model.json",
    MODEL_BASE + "metadata.json"
  );
  await rec.ensureModelLoaded();
  return rec;
}

function sendLine(s){
  if (typeof sendUART === "function") {
    sendUART(String(s) + SEND_SUFFIX);
  } else {
    console.warn("sendUART() ontbreekt ‚Äì is microbit_uart_ble.js juist geladen/benoemd?");
  }
}

async function startListening(){
  try {
    setStatus("Model laden‚Ä¶");
    recognizer = await createModel();
    labels = recognizer.wordLabels();

    setStatus("Luisteren‚Ä¶ (microfoon toestaan)");
    recognizer.listen(result => {
      const scores = result.scores;
      let top = 0;
      for (let i=1; i<scores.length; i++) if (scores[i] > scores[top]) top = i;

      const label = labels[top];
      const prob  = scores[top];

      setStatus(`${label} (${(prob*100).toFixed(0)}%)`);

// ---- Cooldown-protected trigger ----
if (prob >= PROB_THRESHOLD && label !== lastLabel) {
  const now = Date.now();
  const COOLDOWN_MS = 1500; // wait at least 1.5 seconds between triggers
  if (!window.lastTriggerTime || now - window.lastTriggerTime > COOLDOWN_MS) {
    const cmd = (label in MAP_TO_UART) ? MAP_TO_UART[label] : label;
    sendLine(cmd);
    lastLabel = label;
    window.lastTriggerTime = now;
  }
}

    }, {
      includeSpectrogram: true,
      probabilityThreshold: PROB_THRESHOLD,
      invokeCallbackOnNoiseAndUnknown: true,
      overlapFactor: OVERLAP
    });
  } catch (err) {
    console.error(err);
    alert("Kon audio-model niet starten: " + (err.message || "zie console"));
    setStatus("Error");
  }
}

/* ============ 3) Buttons ============ */
$("#start").addEventListener("click", startListening);

</script>
</body>
</html>
