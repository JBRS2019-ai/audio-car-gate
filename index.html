<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TM Audio ‚Äî Minimal</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<style>
  html,body{margin:0;height:100%;background:#e0551b;color:#fff;font:16px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;display:grid;place-items:center}
  button{border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;background:#fff;color:#e0551b}
  #status{margin-top:12px;font-weight:800}
</style>
</head>
<body>

<button id="start">üéôÔ∏è Start Listening</button>
<div id="status">Idle</div>

<script>
  const $ = s => document.querySelector(s);
  const setStatus = t => $("#status").textContent = t;

  function getModelBase(){
    const m = new URL(location.href).searchParams.get("model");
    if (!m) return null;
    return /^https?:\/\//i.test(m) ? (m.endsWith("/") ? m : m + "/")
                                   : `https://teachablemachine.withgoogle.com/models/${m}/`;
  }

  // Wait for tmAudio to be available or fail with a clear reason
  async function ensureTmAudio(){
    if (window.__tmAudioLoaded && typeof tmAudio !== "undefined") return;
    // Give the script a brief moment to load
    for (let i=0; i<20; i++){
      await new Promise(r=>setTimeout(r, 50));
      if (typeof tmAudio !== "undefined") return;
    }
    const msg = window.__tmAudioError || "tmAudio runtime not loaded. Check script URL/order, content blockers, or CSP.";
    throw new Error(msg);
  }

  let model, mic, running = false, last = "";

  async function startListening(){
    if (running) return;
    const base = getModelBase();
    if (!base) { alert("Add ?model=<AudioModelID or full URL>"); return; }

    try {
      await ensureTmAudio();

      setStatus("Loading model‚Ä¶");
      model = await tmAudio.load(base + "model.json", base + "metadata.json");

      setStatus("Opening microphone‚Ä¶");
      mic = new tmAudio.Microphone();
      await mic.setup();       // user permission
      await mic.play();

      setStatus("Listening‚Ä¶");
      running = true;
      loop();
    } catch (err) {
      console.error("initAudio error:", err);
      setStatus("Error: " + (err && err.message ? err.message : "see console"));
      alert("Could not start audio model. " + (err && err.message ? err.message : "See console."));
    }
  }

  async function loop(){
    if (!running) return;
    try {
      const preds = await model.predict(mic);
      preds.sort((a,b)=>b.probability - a.probability);
      const top = preds[0] || {className:"Idle", probability:0};
      setStatus(`${top.className} (${Math.round(top.probability*100)}%)`);

      if (top.className !== last) {
        if (typeof sendUART === "function") sendUART(top.className + "\n");
        last = top.className;
      }
      await tf.nextFrame();
    } finally {
      requestAnimationFrame(loop);
    }
  }

  $("#start").addEventListener("click", startListening);
</script>
</body>
</html>
